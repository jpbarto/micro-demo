name: Build fib-service

on:
    push:
        paths:
            - 'fib-service/**'
            - '.github/workflows/fib-service.build.yaml'
    pull_request:
        paths:
            - 'fib-service/**'
            - '.github/workflows/fib-service.build.yaml'

jobs:
    build:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: fib-service

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push
              uses: docker/build-push-action@v6
              with:
                context: "{{defaultContext}}:fib-service"
                tags: fib-service
                outputs: type=docker,dest=${{ runner.temp }}/fib-service-image.tar

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                name: fib-service-image
                path: ${{ runner.temp }}/fib-service-image.tar

    test:
      needs: build
      runs-on: ubuntu-latest
      steps:
        - name: Download artifact
          uses: actions/download-artifact@v4
          with:
            name: fib-service-image
            path: ${{ runner.temp }}

        - name: Load Docker image
          run: |
            docker load --input ${{ runner.temp }}/fib-service-image.tar

        - name: Run container
          run: docker run -d --name fib-test -p 8080:8080 fib-service

        - name: Wait for service to be ready
          run: |
            for i in {1..10}; do
              curl -s http://localhost:8080/health && exit 0
              sleep 2
            done
            echo "Service did not become ready in time" && exit 1

        - name: Test service with curl
          run: curl -v http://localhost:8080/fibonacci?number=10

        - name: Stop container
          if: always()
          run: docker stop fib-test